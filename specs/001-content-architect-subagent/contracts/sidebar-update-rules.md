# Sidebar Update Rules Contract

**Version**: 1.0.0
**Date**: 2025-11-28
**Purpose**: Define rules for safely updating docs/sidebars.ts without breaking existing content

---

## Overview

The Content Architect Subagent must update `docs/sidebars.ts` to include newly generated chapters while preserving all existing sidebar entries, custom configurations, and manual edits (FR-012).

---

## File Structure

### Standard Docusaurus sidebars.ts

```typescript
import type {SidebarsConfig} from '@docusaurus/plugin-content-docs';

const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    // Sidebar items go here
  ],
};

export default sidebars;
```

### Sidebar Item Types

**1. Document Link**
```typescript
{
  type: 'doc',
  id: 'intro',
  label: 'Getting Started',
}
```

**2. Category (Used for Chapters)**
```typescript
{
  type: 'category',
  label: 'Chapter 1: Foundations',
  items: [
    'chapter-01-foundations/lesson-01-intro',
    'chapter-01-foundations/lesson-02-landscape',
  ],
}
```

**3. External Link**
```typescript
{
  type: 'link',
  label: 'Official Docs',
  href: 'https://example.com',
}
```

**4. Auto-generated Category**
```typescript
{
  type: 'autogenerated',
  dirName: 'guides',
}
```

---

## Update Strategy

### Step 1: Read Existing File

**Action**: Read `docs/sidebars.ts` into memory

**Validation**:
- File must exist (fail if not)
- File must be valid TypeScript syntax
- File must contain `tutorialSidebar` array

**Example Read**:
```typescript
const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    {
      type: 'doc',
      id: 'intro',
      label: 'Welcome',
    },
  ],
};
```

---

### Step 2: Parse Sidebar Array

**Action**: Extract the `tutorialSidebar` array contents

**Parsing Strategy**: String-based parsing (not full AST)

**Steps**:
1. Find `tutorialSidebar: [` opening
2. Find matching closing `]` (track bracket depth)
3. Extract content between brackets
4. Preserve all existing items

**Edge Cases**:
- Handle nested arrays (category items)
- Handle trailing commas
- Handle comments (preserve them)
- Handle multi-line formatting

---

### Step 3: Detect Duplicates

**Action**: Check if new category already exists in sidebar

**Detection Logic**:
```javascript
// Check if label already exists
const existingLabels = sidebar.items
  .filter(item => item.type === 'category')
  .map(item => item.label);

const newLabel = 'Chapter 1: Foundations';

if (existingLabels.includes(newLabel)) {
  console.warn(`Sidebar already contains '${newLabel}', skipping duplicate`);
  return; // Skip adding this category
}
```

**Duplicate Criteria**:
- Exact label match (case-sensitive)
- Category with same items array

**Behavior**:
- If duplicate detected: Skip adding, log warning, continue
- If not duplicate: Proceed to add

---

### Step 4: Generate New Category Object

**Action**: Create TypeScript object for new chapter

**Template**:
```typescript
{
  type: 'category',
  label: '{{CHAPTER_LABEL}}',
  items: [
    {{#each lessons}}
    '{{lesson.document_id}}',
    {{/each}}
  ],
}
```

**Variables**:
- `{{CHAPTER_LABEL}}`: "Chapter #: Title" (e.g., "Chapter 1: Foundations")
- `{{lesson.document_id}}`: "chapter-##-slug/lesson-##-slug" (without .md extension)

**Example Output**:
```typescript
{
  type: 'category',
  label: 'Chapter 1: Foundations',
  items: [
    'chapter-01-foundations/lesson-01-introduction-embodied-intelligence',
    'chapter-01-foundations/lesson-02-robotics-landscape',
  ],
}
```

---

### Step 5: Insert New Category

**Action**: Append new category to tutorialSidebar array

**Insertion Point**: End of array (before closing bracket)

**Formatting Rules**:
1. Add comma after previous last item (if not present)
2. Add new category object
3. Add trailing comma after new category
4. Preserve indentation (2 spaces per level)
5. Add newline after closing brace

**Example Transformation**:

**BEFORE**:
```typescript
const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    {
      type: 'doc',
      id: 'intro',
      label: 'Welcome',
    },
  ],
};
```

**AFTER**:
```typescript
const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    {
      type: 'doc',
      id: 'intro',
      label: 'Welcome',
    },
    {
      type: 'category',
      label: 'Chapter 1: Foundations',
      items: [
        'chapter-01-foundations/lesson-01-introduction-embodied-intelligence',
        'chapter-01-foundations/lesson-02-robotics-landscape',
      ],
    },
  ],
};
```

---

### Step 6: Validate TypeScript Syntax

**Action**: Verify updated file is valid TypeScript

**Validation Methods**:

**Method 1: Docusaurus Build** (Recommended)
```bash
cd docs && npm run build
```
- If exit code 0: Valid
- If exit code non-zero: Invalid, report error

**Method 2: TypeScript Compiler** (Faster)
```bash
npx tsc --noEmit docs/sidebars.ts
```
- Check for syntax errors

**Method 3: ESLint** (If configured)
```bash
npx eslint docs/sidebars.ts
```

**Error Handling**:
- If validation fails, report error with compiler output
- Do not overwrite original file if validation fails

---

### Step 7: Write Updated File

**Action**: Write modified sidebars.ts back to disk

**Safety Checks**:
1. Create backup: `sidebars.ts.backup` (optional)
2. Write to temporary file: `sidebars.ts.tmp`
3. Validate temporary file
4. Rename temporary file to `sidebars.ts`

**Atomic Write**:
```bash
# Write to temp file
cat > docs/sidebars.ts.tmp << 'EOF'
[content]
EOF

# Validate
npx tsc --noEmit docs/sidebars.ts.tmp

# If valid, replace original
mv docs/sidebars.ts.tmp docs/sidebars.ts
```

---

## Preservation Rules (FR-012)

### Rule 1: Preserve All Existing Items

**Requirement**: Never remove or modify existing sidebar items

**Examples of Existing Items to Preserve**:
- Manual doc links
- Custom categories
- External links
- Comments
- Custom properties

**CORRECT**:
```typescript
// BEFORE
tutorialSidebar: [
  { type: 'doc', id: 'intro' },  // Manual entry
]

// AFTER (preserves manual entry)
tutorialSidebar: [
  { type: 'doc', id: 'intro' },  // Manual entry (preserved)
  { type: 'category', label: 'Chapter 1: Foundations', items: [...] },  // Added
]
```

**INCORRECT** (Violation of FR-012):
```typescript
// BEFORE
tutorialSidebar: [
  { type: 'doc', id: 'intro' },
]

// AFTER (manual entry removed - WRONG!)
tutorialSidebar: [
  { type: 'category', label: 'Chapter 1: Foundations', items: [...] },
]
```

---

### Rule 2: Preserve Comments

**Requirement**: Keep all code comments in place

**Example**:
```typescript
// BEFORE
tutorialSidebar: [
  // Welcome section (do not remove)
  { type: 'doc', id: 'intro' },
]

// AFTER (comment preserved)
tutorialSidebar: [
  // Welcome section (do not remove)  â† Preserved
  { type: 'doc', id: 'intro' },
  { type: 'category', label: 'Chapter 1: Foundations', items: [...] },
]
```

---

### Rule 3: Preserve Formatting

**Requirement**: Maintain indentation and line breaks

**Indentation**: 2 spaces per level (Docusaurus default)

**Example**:
```typescript
{
  type: 'category',
  label: 'Chapter 1: Foundations',
  items: [
    'chapter-01-foundations/lesson-01',
    'chapter-01-foundations/lesson-02',
  ],
}
```

---

### Rule 4: Preserve Custom Properties

**Requirement**: Keep any custom fields in sidebar items

**Example**:
```typescript
// BEFORE
{
  type: 'doc',
  id: 'intro',
  customProps: {
    featured: true,
    icon: 'ðŸš€',
  },
}

// AFTER (customProps preserved)
{
  type: 'doc',
  id: 'intro',
  customProps: {         â† Preserved
    featured: true,
    icon: 'ðŸš€',
  },
}
```

---

## Edge Cases

### Edge Case 1: Empty Sidebar

**Scenario**: `tutorialSidebar` array is empty

**Handling**:
```typescript
// BEFORE
const sidebars: SidebarsConfig = {
  tutorialSidebar: [],
};

// AFTER (add first category without leading comma)
const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    {
      type: 'category',
      label: 'Chapter 1: Foundations',
      items: [
        'chapter-01-foundations/lesson-01',
        'chapter-01-foundations/lesson-02',
      ],
    },
  ],
};
```

---

### Edge Case 2: Multiple Sidebars

**Scenario**: File contains multiple sidebar definitions

**Handling**: Only modify `tutorialSidebar`, leave others untouched

**Example**:
```typescript
const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    // Modify this sidebar
  ],
  apiSidebar: [
    // Leave this unchanged
  ],
};
```

---

### Edge Case 3: Autogenerated Sidebars

**Scenario**: Sidebar uses `type: 'autogenerated'`

**Handling**: Do not modify autogenerated sections, append new categories separately

**Example**:
```typescript
const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    {
      type: 'autogenerated',
      dirName: 'guides',  // â† Leave this untouched
    },
    {
      type: 'category',
      label: 'Chapter 1: Foundations',  // â† Add new category after
      items: [...],
    },
  ],
};
```

---

### Edge Case 4: Nested Categories

**Scenario**: Sidebar has nested categories (categories within categories)

**Handling**: Append at top level, do not nest within existing categories

**Example**:
```typescript
tutorialSidebar: [
  {
    type: 'category',
    label: 'Getting Started',
    items: [
      { type: 'category', label: 'Installation', items: [...] },  // â† Nested
    ],
  },
  {
    type: 'category',
    label: 'Chapter 1: Foundations',  // â† Add at top level (not nested)
    items: [...],
  },
]
```

---

## Validation Checklist

After updating sidebars.ts, verify:

- [ ] File is valid TypeScript syntax
- [ ] All existing items preserved
- [ ] No duplicate categories added
- [ ] Document IDs reference existing lesson files
- [ ] Trailing commas present (TypeScript best practice)
- [ ] Indentation is consistent (2 spaces)
- [ ] Comments preserved
- [ ] Docusaurus build succeeds (`npm run build`)

---

## Error Messages

### Syntax Error
```text
âŒ Error: Invalid TypeScript syntax in sidebars.ts

Syntax error details:
[TypeScript compiler output]

The file has not been modified. Please fix syntax errors manually and retry.
```

### Missing File
```text
âŒ Error: docs/sidebars.ts not found

Ensure Docusaurus is initialized. Expected file location:
/path/to/project/docs/sidebars.ts
```

### Duplicate Category
```text
âš ï¸  Warning: Sidebar already contains 'Chapter 1: Foundations'

Skipping duplicate category. Existing sidebar entry will be preserved.
```

### Build Failure
```text
âŒ Error: Docusaurus build failed after sidebar update

Build output:
[npm run build output]

The sidebar may have invalid document references. Check that all lesson files exist.
```

---

## Testing Contract

### Manual Test: Fresh Sidebar

**Setup**:
```bash
# Start with minimal sidebar
cat > docs/sidebars.ts << 'EOF'
import type {SidebarsConfig} from '@docusaurus/plugin-content-docs';

const sidebars: SidebarsConfig = {
  tutorialSidebar: [],
};

export default sidebars;
EOF
```

**Execute**: Run Content Architect agent

**Verify**:
- 3 new categories added
- Valid TypeScript syntax
- Docusaurus build succeeds

---

### Manual Test: Preserve Manual Edits

**Setup**:
```bash
# Add manual entry
cat > docs/sidebars.ts << 'EOF'
import type {SidebarsConfig} from '@docusaurus/plugin-content-docs';

const sidebars: SidebarsConfig = {
  tutorialSidebar: [
    {
      type: 'doc',
      id: 'intro',
      label: 'Welcome',
    },
  ],
};

export default sidebars;
EOF
```

**Execute**: Run Content Architect agent

**Verify**:
- Manual entry still present
- 3 new categories added after manual entry
- Valid TypeScript syntax

---

### Manual Test: Idempotent Re-run

**Setup**: Run agent twice with same parameters

**Verify**:
- First run: 3 categories added
- Second run: Warning messages for duplicates, no new categories added
- Sidebar unchanged after second run

---

## Implementation Pseudocode

```python
def update_sidebar(chapters: List[Chapter]) -> Result:
    # Step 1: Read
    sidebar_content = read_file("docs/sidebars.ts")
    if not sidebar_content:
        return Error("sidebars.ts not found")

    # Step 2: Parse
    sidebar_array = extract_tutorial_sidebar(sidebar_content)
    existing_labels = extract_category_labels(sidebar_array)

    # Step 3-4: Generate & Check Duplicates
    new_categories = []
    for chapter in chapters:
        category_label = f"Chapter {chapter.number}: {chapter.title}"

        if category_label in existing_labels:
            log_warning(f"Duplicate: {category_label}")
            continue

        category_obj = generate_category_object(chapter)
        new_categories.append(category_obj)

    # Step 5: Insert
    updated_content = insert_categories(sidebar_content, new_categories)

    # Step 6: Validate
    write_file("docs/sidebars.ts.tmp", updated_content)
    if not validate_typescript("docs/sidebars.ts.tmp"):
        return Error("TypeScript validation failed")

    # Step 7: Write
    rename_file("docs/sidebars.ts.tmp", "docs/sidebars.ts")

    return Success()
```

---

**Contract complete. This defines all rules for safely updating sidebars.ts while preserving manual edits.**
